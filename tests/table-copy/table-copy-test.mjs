// Generated by ü§ñ
import assert from 'assert';
import { readTestData } from '../test-utils.mjs';

async function testTableCopy(debug = false) {
  try {
    const { wasmBuffer, ast } = await readTestData('table-copy/table-copy.wat', debug);

    // Verify AST structure
    assert(ast[0].tables && ast[0].tables.length > 0, 'Table should be present in AST');
    assert.strictEqual(ast[0].tables[0].min, 4, 'Table min size should be 4');
    
    // Verify element segments
    assert(ast[0].elements && ast[0].elements.length === 1, 'Should have one element segment');
    
    // Instantiate and test
    const { instance } = await WebAssembly.instantiate(wasmBuffer);
    
    // Test table contents
    const table = instance.exports.tbl;
    assert(table instanceof WebAssembly.Table, 'Table should be exported');
    assert.strictEqual(table.length, 4, 'Table should have length 4');
    
    // Initial table state should be:
    // [f1(42), f2(43), f3(44), null]
    const getFunc = instance.exports.get_func;
    
    // Verify initial state
    assert.strictEqual(getFunc(0)(), 42, 'Initial: Function at index 0 should return 42');
    assert.strictEqual(getFunc(1)(), 43, 'Initial: Function at index 1 should return 43');
    assert.strictEqual(getFunc(2)(), 44, 'Initial: Function at index 2 should return 44');
    
    // Test copying functions within the table
    instance.exports.copy_table(3, 0, 1); // Copy f1 to index 3
    assert.strictEqual(getFunc(3)(), 42, 'After copy: Function at index 3 should return 42');
    
    // Test overlapping copy (should work like memmove)
    instance.exports.copy_table(1, 0, 2); // Copy [f1,f2] to [1,2]
    assert.strictEqual(getFunc(1)(), 42, 'After overlap copy: Function at index 1 should return 42');
    assert.strictEqual(getFunc(2)(), 43, 'After overlap copy: Function at index 2 should return 43');
    
    if (debug) console.log('‚úÖ Table copy test passed');
    return true;
  } catch (error) {
    console.error('‚ùå Test failed:', error);
    return false;
  }
}

export default testTableCopy;